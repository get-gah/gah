name: ðŸ§ª Integration Tests

on:
  workflow_call:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - title: Linux (Ubuntu) @amd64
            runner: ubuntu-slim

          - title: Linux (Alpine) @amd64
            runner: ubuntu-latest
            container: library/alpine:3
            pre-run: apk add --no-cache jq openssl bash git curl tar unzip

          - title: MacOS @arm64
            runner: macos-15
            pre-run: env

          - title: MacOS @amd64
            runner: macos-15-intel
            pre-run: env

    name: Test on ${{ matrix.title }}
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}

    steps:
      - name: Pre-run
        if: ${{ matrix.pre-run }}
        shell: sh
        run: ${{ matrix.pre-run }}

      - name: Check pre-requisites
        shell: bash
        run: |
          if [ "${BASH_VERSINFO[0]}" -lt 3 ]; then
            echo "::error title=Pre-requisite failed::Bash 3.0 or higher is required"
            exit 1
          fi

          required_commands=(tar unzip curl jq openssl)
          for cmd in "${required_commands[@]}"; do
            if ! command -v "$cmd" &> /dev/null; then
              echo "::error title=Pre-requisite failed::$cmd is not installed"
              exit 1
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare environment
        shell: bash
        env:
          RUNNER_TEMP: ${{ runner.temp }}
        run: |
          echo "UNATTENDED=true" >> $GITHUB_ENV

          GAH_CACHE_DIR="$RUNNER_TEMP/.cache"
          echo "GAH_CACHE_DIR=$GAH_CACHE_DIR" >> $GITHUB_ENV
          mkdir -p "$GAH_CACHE_DIR"

          GAH_INSTALL_DIR="$RUNNER_TEMP/.bin"
          echo "GAH_INSTALL_DIR=$GAH_INSTALL_DIR" >> $GITHUB_ENV
          mkdir -p "$GAH_INSTALL_DIR"
          cp gah "$GAH_INSTALL_DIR/gah"

          # Add GAH_INSTALL_DIR to PATH
          echo "PATH=$GAH_INSTALL_DIR:$PATH" >> $GITHUB_ENV

          # Enable debug logging
          echo "GAH_DEBUG=true" >> $GITHUB_ENV

      - name: Install something
        shell: bash
        env:
          GITHUB_PAT: ${{ github.token }}
        run: gah install mikefarah/yq

      - name: Test if yq was installed correctly
        run: yq --version
